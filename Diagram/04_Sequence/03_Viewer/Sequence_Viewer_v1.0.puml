@startuml
title Видеохостинг - Диаграмма взаимодействия зрителя
actor "Зритель" as Viewer
' 1. Клиентский уровень
box "Client layer"
    participant "Web UI" as UI
    participant "Video Player" as VideoPlayer
end box
' 2. Backend
box "Backend API layer"
    participant "API Gateway" as API
end box
' 3. Сервисы
box "Services"
    participant "Auth Service" as AuthService
    participant "User Service" as UserService
    participant "Video Management Service" as VideoManagementService
    participant "Search Service" as SearchService
    participant "Streaming Service" as StreamingService
    participant "Like Service" as LikeService
    participant "Comment Service" as CommentService
    participant "Statistics Service" as StatisticsService
end box
' 4. Обработка видео
box "Video processing"
    participant "Upload Service" as UploadService
    participant "Transcoding Service" as TranscodingService
    queue "Message Queue" as MQ
end box
' 5. Инфраструктура
box "Infrastructure"
    database "User DB" as UserDB
    database "Video Metadata DB" as MetadataDB
    participant "Object Storage" as ObjectStorage
    participant "CDN" as CDN
end box

===UC3.1.1 Войти в личный кабинет===

autonumber 1.1

==Открытие формы входа==

Viewer -> UI : Открыть страницу входа
UI --> Viewer : Отобразить страницу входа

==Ввод данных==

Viewer -> UI : Ввести данные для входа и подтвердить вход
UI -> API : POST /api/auth/login

==Аутентификация==

API -> AuthService : checkAuth()
AuthService -> UserDB : Получить пользователя
UserDB --> AuthService : User + password_hash

AuthService -> AuthService : Проверка пароля (hash + salt)

alt Данные корректны
    AuthService -> AuthService : Сформировать JWT
    Auth --> API : JWT + роль
    API --> UI : 200 OK (JWT)
    UI -> UI : Сохранить JWT (cookie / storage)
    UI --> Viewer : Доступ предоставлен
else Данные некорректны
    AuthService --> API : Ошибка аутентификации
    API --> UI : 401 Unauthorized
    UI --> Viewer : Сообщение об ошибке
end

===UC3.1.2 Выйти из личного кабинета===

==Инициация выхода==

Viewer -> UI : Нажать "Выход"
UI -> API : POST /api/auth/logout

==Завершение сессии==

API -> AuthService : invalidateToken(JWT)
AuthService --> API : 200 OK
API --> UI : 200 OK
UI -> UI : Удалить JWT
UI --> Viewer : Перенаправление на главную страницу

===UC3.1.3 / UC3.1.4 Добавить и отозвать лайк к видео======

==Открытие видео==

Viewer -> UI : Выбрать видео
UI -> API : GET /api/videos/{videoId}

==Добавление / отзыв лайка==

Viewer -> UI : Нажать "Лайк"
UI -> API : POST /api/videos/{videoId}/like
API -> AuthService : checkAuth()
AuthService --> API : 200 OK

alt Лайка еще нет
    API -> LikeService : addLike(userId, videoId)
    LikeService -> MetadataDB : insert like
    LikeService -> MetadataDB : increment likesCount
    LikeService --> API : likeAdded
    API --> UI: Счетчик лайков обновлен
    UI --> Viewer : Лайк добавлен
else Лайк уже есть
    API -> LikeService : removeLike(userId, videoId)
    LikeService -> MetadataDB : delete like
    LikeService -> MetadataDB : decrement likesCount
    LikeService --> API : likeRemoved
    API --> UI: Счетчик лайков обновлен
    UI --> Viewer : Лайк удален
end

===UC3.1.5 / UC3.1.6 Добавить и удалить комментарий к видео======

==Открытие видео==

Viewer -> UI : Выбрать видео
UI -> API : GET /api/videos/{videoId}

==Добавление комментария==

Viewer -> UI : Ввести комментарий
UI -> API : POST /api/videos/{videoId}/comment
API -> AuthService : checkAuth()
AuthService --> API : 200 OK

CommentService -> CommentService : validate(commentText)

alt Комментарий корректный
    API -> CommentService : addComment(userId, videoId, commentText)
    CommentService -> MetadataDB : insert comment
    CommentService --> API : commentAdded
    API --> UI: Отобразить комментарий
    UI --> Viewer : Отобразить комментарий
else Комментарий пустой
    API -> UI : Ошибка валидации

==Удаление комментария==

Viewer -> UI : Удалить комментарий
UI -> API : DELETE /api/videos/{videoId}/comment/{commentId}
API -> AuthService : checkAuth()
AuthService --> API : 200 OK

API -> CommentService : checkOwnership(userId, commentId)
CommentService -> MetadataDB : find comment

alt Комментарий принадлежит зрителю
    CommentService -> MetadataDB : Удалить комментарий
    CommentService --> API : commentDeleted
    API --> UI : Комментарий удален
    UI --> Viewer : Комментарий удален
else Комментарий не принадлежит зрителю
    API -> UI : Ошибка доступа

@enduml